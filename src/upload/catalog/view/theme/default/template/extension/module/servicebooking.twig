{# {{ header }} #}
{# <script src="https://www.google.com/recaptcha/api.js" async defer></script> #}
<style>
.servicebooking-content {
    background-color: #fff;
    margin: 4rem auto 6rem;
}
#content .servicebooking-content h1 {
    transform: none;
    font-size: 3rem;
    margin: 20px 0 10px;
}
.servicebooking-content > div {
    background-color: #fff;
    margin: 0;
    padding-top: 1rem;
    display: block;
    padding-right: 0;
}
.servicebooking-content > div.booking-grid {
    padding-left: 0;
    padding-right: 2.5rem;
}
.modal-title {
    font: 400 3rem/1 edo_sz, sans-serif;
    text-align: center;
    color: #008000;
    letter-spacing: 0.15rem;
}
.modal-header {
    padding: 10px;
}
.modal-header .close {
    position: absolute;
    right: 10px;
    top: 3px;
    font-size: 3rem;
    font-weight: 400;
}
.modal-body h3 {
    margin: 0 0 1.5rem;
    font-size: 2.5rem;
}
.modal-body strong {
    font-weight: 700;
}
.modal-recommend {
    text-align: center;
    display: block;
    border: 3px solid #ccc;
    border-radius: 4px;
    padding: 0.5rem;
    margin: 0 1rem 1rem;
    font-size: 1.6rem;
}
#book-service, #check-service {
    display: grid;
    grid-template-columns: 0.5fr 1fr 1fr;
    grid-auto-rows: 32px;
    grid-gap: 15px;
    grid-template-areas:
        "label1 input1 p"
        "label2 input2 p"
        "label3 input3 button";
    border: 3px solid #008000;
    padding: 1.25rem 2rem;
}
#check-service {
    grid-template-areas: "label1 input1 button";
}
.servicebooking-content h2 {
    color: #008000;
    font: 400 3rem/1 edo_sz, sans-serif;
    letter-spacing: 0.02em;
    padding-left: 3px;
}
.booking-grid label {
    font-size: 1.75rem;
    line-height: 1;
    display: flex;
    align-items: center;
}
.booking-grid .label1 {
    grid-area: label1;
}
.booking-grid .label2 {
    grid-area: label2;
}
.booking-grid .label3 {
    grid-area: label3;
}
.booking-grid input, input[type="text"].form-control {
    font-size: 1.75rem;
    line-height: 1;
    border-radius: 5px;
    border: 1px solid #bbb;
    padding-left: 8px;
    /* color: #757575 !important; */
}
.booking-grid .input1 {
    grid-area: input1;
}
.booking-grid .input2 {
    grid-area: input2;
}
.booking-grid .input3 {
    grid-area: input3;
}
.booking-grid button {
    grid-area: button;
    width: 100%;
    font-size: 1.75rem;
}
.booking-grid .ready-date {
    grid-area: p;
    line-height: 1;
    font-size: 1.75rem;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    text-align: center;
}
.ready-date span {
    color: #008000;
    background-color: #fff;
    font-weight: 700;
    font-size: 1.2em;
    padding: 0 0.5rem;
    transition: transform 0.2s;
}
.ready-date span.flash {
    transform: scale(1.5);
}
@media screen and (max-width: 1250px) {
    .booking-grid .ready-date {
        font-size: 1.5rem;
    }
}
@media screen and (max-width: 1200px) {
    .booking-grid .ready-date {
        font-size: 1.75rem;
    }
}
@media screen and (max-width: 1024px) {
    #book-service, #check-service {
        grid-template-columns: 0.5fr 1fr;
        grid-template-areas:
            "label1 input1"
            "label2 input2"
            "label3 input3"
            "p p"
            "button button";
    }
    #check-service {
        grid-template-areas:
            "label1 input1"
            "button button";
    }
}
.bootstrap-datetimepicker-widget.bottom {
    background-color: #fff;
}
.bootstrap-datetimepicker-widget td.day {
    color: #008000;
    font-weight: 700;
    font-size: 16px;
}

.bootstrap-datetimepicker-widget td.today:before {
    display: none;
}

.bootstrap-datetimepicker-widget td.today {
    box-shadow: 0 0 0 2px rgba(40, 155, 0, 0.35) inset;
}

.bootstrap-datetimepicker-widget td.active {
    background-color: #008000;
    color: #fff;
}
.bootstrap-datetimepicker-widget td.day.disabled {
    color: #ccc;
    font-weight: 300;
    font-size: 12px;
}
@media screen and (max-width: 767px) and (min-width: 551px),
       screen and (max-width: 400px) {
    .servicebooking-bikes em {
        font-size: 3.6vw;
    }
    #book-service, #check-service {
        grid-template-columns: 1fr;
        grid-template-areas:
            "label1"
            "input1"
            "label2"
            "input2"
            "label3"
            "input3"
            "p"
            "button";
        grid-template-rows: 10px 35px 10px 35px 10px 36px 45px 30px;
        grid-gap: 8px;
    }
    #check-service {
        grid-template-areas:
            "label1"
            "input1"
            "button";
        grid-template-rows: 10px 35px 30px;
    }
}
@media screen and (max-width: 550px) {
    .servicebooking-bikes {
        flex-direction: column;
        align-items: center;
        margin-top: 1rem;
    }
    .servicebooking-bikes em {
        font-size: 3.5rem;
        margin-top: 3rem;
        max-width: unset;
    }
    .servicebooking-bikes em::after {
        max-width: 50vw;
        padding: 0;
        height: 28vw;
    }
    .servicebooking-content {
        flex-direction: column;
        padding: 1rem 0 2rem;
    }
    .servicebooking-content > div {
        width: 100%;
        padding: 0 2.5rem !important;
    }
}
.g-recaptcha {
    position: absolute;
    z-index: 1000;
}
.g-recaptcha > div {
    outline: 1.5rem solid #279a00;
    top: -1px;
    left: -8px;
    position: relative;
}
</style>
<div class="servicebooking-content content">
    <div class="col-md-6 booking-grid">
        <h2>Jetzt Service buchen:</h2>
        <form id="book-service" class="form-inline">
            <label class="label1" for="book-name">Name: </label>
            <input class="input1" type="text" class="form-control" required id="book-name" placeholder="Name" name="servicebooking_name">
            <p class="ready-date">Das Rad kann am <span>--.--.-----</span> wieder abgeholt werden.</p>
            <label class="label2" for="book-date">Bringtermin:</label>
            <div class='input-group date input2' id='datetimepicker'>
                <input type="text" class="form-control" required id="book-date" name="servicebooking_date">
                <input type="hidden" id="book-enter" name="servicebooking_enter">
                <span class="input-group-addon" style="width:41px">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
            <input type="hidden" id="book-leave" name="servicebooking_leave">
            <label class="label3"l for="book-contact">Erreichbar unter:</label>
            <input class="input3" type="text" class="form-control" required id="book-contact" placeholder="E-Mail/Tel-Nr." name="servicebooking_contact">
            <button class="btn btn-primary col-md-4" type="submit">Jetzt buchen</button>
        </form>
        <h2>Bearbeitungs&shy;stand checken:</h2>
        <form id="check-service" class="form-inline">
            <label class="label1" for="service-nr">Bearbeitungs-Nr:</label>
            <input class="input1" type="text" class="form-control" required id="service-nr" placeholder="Nummer" name="servicebooking_nr">
            <button class="btn btn-primary col-md-4" type="submit">Jetzt abfragen</button>
        </form>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="statusMsg" tabindex="-1" role="dialog" aria-labelledby="statusMsgLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statusMsgLabel"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>
</div>
<script>
var no_booking = [{{ dates }}],
    $date,
    open = {
        day_1: {% if settings.day_1 %}1{% else %}0{% endif %},
        day_2: {% if settings.day_2 %}1{% else %}0{% endif %},
        day_3: {% if settings.day_3 %}1{% else %}0{% endif %},
        day_4: {% if settings.day_4 %}1{% else %}0{% endif %},
        day_5: {% if settings.day_5 %}1{% else %}0{% endif %},
        day_6: {% if settings.day_6 %}1{% else %}0{% endif %},
        day_7: {% if settings.day_7 %}1{% else %}0{% endif %}
    },
    total_open = open.day_1+open.day_2+open.day_3+open.day_4+open.day_5+open.day_6+open.day_7,
    service_duration = {{ settings.service_duration }},
    circle = Math.ceil(service_duration/total_open)*7,
    never = false;
$('#check-service').on('submit', function(e){
    e.preventDefault();
    var data = $(this).serialize();
    jQuery.post(
        '/index.php?route=extension/module/servicebooking/getStatus',
        data,
        function(msg) {
            $('#statusMsgLabel').text('Service-Bearbeitungsstand');
            $('#statusMsg .modal-body').html(msg);
            $('#statusMsg').modal();
        }
    )
})
$('#datetimepicker').datetimepicker({
	'format': 'll',
	'locale': '{{ datepicker }}',
	'allowInputToggle': true,
    'minDate': moment(),
    'maxDate': moment().add({{ max_future }}, 'd'),
    'disabledDates': no_booking,
    'defaultDate': moment()
});
$date = $('#datetimepicker').data("DateTimePicker");
$(document).on('dp.change', '#datetimepicker', function(e) {
    var selected = e.date.format('YYYY-MM-DD');
    if (no_booking.indexOf(selected) != -1) {
        if (!moment(selected).add(1, 'day').isBefore(moment().add({{ max_future }}, 'd').subtract(1, 'day'))) {
            $date.date(e.date.subtract(1, 'day'));
        } else {
            $date.date(e.date.add(1, 'day'));
        }
    }
    $(document).one('dp.hide', '#datetimepicker', setFuture);
});
function setFuture() {
    var then,
        future = 0,
        day,
        check,
        duration = service_duration,
        $ready = $('.ready-date span');
    day = $date.getDate().day();
    day = day == 0 ? 7 : day; // Sunday = 7;
    check = day;
    for (var i=day; i <= (day+circle); i++){
        // ein weiterer Tag
        ++future;
        // welcher Wochentag?
        check = check > 6 ? check - 6 : check+1;
        // Gearbeitet wir nur an offenen Tagen
        if(open['day_'+check] == 1) --duration;
        // Wenn Bearbeitungszeit rum UND offen dann ist fertig
        if(duration <= 0   && open['day_'+check] == 1) break;
    }
    then = moment($date.getDate()).add(future, 'day').format('ll');
    $('#book-leave').val(moment($date.getDate()).add(future, 'day').format('YYYY-MM-DD'));
    $ready.text(then);
    if (never) {
        $ready.addClass('flash');
        window.setTimeout(function(){
            $ready.removeClass('flash');
        }, 200);
    } else {
        never = true;
    }
}
setFuture();
$('#book-service').on('submit', function(e){
    e.preventDefault();
    var tolken = '{{ tolken }}';
    var raw = moment($('#book-date').val(), "ll").format('YYYY-MM-DD');
    $('#book-enter').val(raw);
    var data = $(this).serialize() + "&tolken=" + tolken;
    console.log(data);
    jQuery.post(
        '/index.php?route=extension/module/servicebooking/saveBooking',
        data,
        function(msg) {
            $('#statusMsgLabel').text('Servicebuchung');
            $('#statusMsg .modal-body').html(msg);
            $('#statusMsg').modal();
        }
    )
})
</script>
